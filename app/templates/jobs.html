<!DOCTYPE html>
<html>
<head lang="en">
	<link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css">
	<script src="/static/jquery/jquery.min.js"></script>
	<script src="/static/bootstrap/js/bootstrap.min.js"></script>
	<script src="/static/js/common.js"></script>
	<script src="/static/js/layer.js"></script>
</head>
<body>
<table class="table">
	<thread>
		<tr>
			<th>ID</th>
			<th>NAME</th>
			<th>Type</th>
			<th>RelateCase</th>
			<th>RelateDevice</th>
			<th>Status</th>
			<th>CreatedTime</th>
			<th>Operation</th>
		</tr>
	</thread>
	<tbody>
	{% for job in jobs %}
		<tr>
			<th>{{ job.id }}</th>
			<th>{{ job.jobName }}</th>
			<th>{{ job.jobType }}</th>
			<th>{{ job.relateCases }}</th>
			<th>{{ job.relateDevices }}</th>
			<th>{{ job.status }}</th>
			<th>{{ job.createdtime }}</th>
			<th>
				<div class="btn-group">
					{% if job.status != 2 %}
						<button type="button" id="{{ job.id }}" class="btn btn-primary runbtn">运行</button>
						<a id="viewreport_{{ job.id }}" name="{{ job.id }}" class="btn btn-info viewreport" style="display:none">查看报告</a>
					{% else %}
						<a id="viewreport_{{ job.id }}" name="{{ job.id }}" class="btn btn-info viewreport">查看报告</a>
					{% endif %}
					<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						<span class="caret"></span>
						<span class="sr-only">Toggle Dropdown</span>
					</button>
					<ul class="dropdown-menu">
						<li><a href="/deljob/{{ job.id }}">删除</a></li>
					</ul>
				</div>
			</th> 
		</tr>
	{% endfor %}
	</tbody>
</table>
<script>
	$(function(){

		interval = setInterval("resizeFrame()",50);

		getStatus()

		{% for message in get_flashed_messages() %}
			parent.layer.msg("{{message}}")
		{% endfor %}

		$(".runbtn").click(function(){
			$(this).html("正在运行..").attr("disabled","disabled")
			$(".runbtn").attr("disabled","disabled")
			$.ajax({
				url:"/runjob/"+this.id,
				type:"post",
				async:true,
				error:function(request){
					console.log(request.status)
				},
				success:function(data){
					if(!data.result){
						parent.layer.msg(data.info)
					}else{
						parent.layer.msg("正在运行")
					}
				}
			})
		})

		$(".viewreport").click(function(){
			parent.viewreport($(this).attr("name"));
		})
	})

	function getStatus(){
		var source = new EventSource("/getStatus");
		source.onmessage = function(event){
			var resp = JSON.parse(event.data);
			if(resp.jobid){
				if(resp.status == 1){
					$("#"+resp.jobid).html("正在运行..").attr("disabled","disabled")
					$(".runbtn").attr("disabled","disabled")
				}else if(resp.status == 2){
					$("#"+resp.jobid).hide()
					$("#viewreport_"+resp.jobid).show()
					$(".runbtn").removeAttr("disabled")
					parent.layer.msg("运行完成")
				}else{

				}
			}else{

			}
		}
	}

</script>

</body>
</html>